<!doctype html>
<html>
<head>
  <meta http-equiv="Cache-Control" content="no-store" />
  <script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
</head>
<body>
    <h1>Vorwerk V100 Robotic Vacuum</h1>

    <fieldset>
        <legend><span>Add VR100 devices</span></legend>
        <p><b>Note</b> - Don't forget to give your VR100 vacuum's static IPs.</p>
        <div class="field row">
            <label style="width: 260px;"><span>Device IP address</span></label>
            <label style="width: 260px;"><span>Device Nickname</span></label>
        </div>
        <div class="field row new_device">
            <input class="device_ip" name="device_ips[]" type="text" value=""/>
            <input class="device_nickname" name="device_nicknames[]" type="text" value=""/>
        </div>
        <div class="field row add_device">
            <button id="add" class="left" onclick="addDevice()">Add device</button>
        </div>
    </fieldset>

    <button id="save" class="left" onclick="saveSettings()">Save settings</button>

    <script type="text/javascript">
      function onHomeyReady() {
        // Hide some elements initially.
        $('#row-auto-discovered').hide()

        // Fill input with already stored settings.
        Homey.get('devices', function (err, devices) {
          if (devices) {
            for (var i = 0; i < devices.length; i++) {
              var device = devices[i]
              var newDevice = $(".new_device").clone()
              newDevice.removeClass("new_device")
              $(".device_ip", newDevice).val(device.ip)
              $(".device_nickname", newDevice).val(device.nickname)
              newDevice.insertBefore(".new_device")
            }
          }
          // We're ready!
          Homey.ready()
        })
      }

      function addDevice() {
        var newDevice = $(".new_device").clone()
        newDevice.removeClass("new_device")
        $(".device_ip", newDevice).val("")
        $(".device_nickname", newDevice).val("")
        newDevice.insertBefore(".add_device")
        $(".device_ip", newDevice).focus()
      }

      function saveSettings() {
        console.log("Saving settings...")
        var devices = []
        var deviceIPS = $('input[name^=device_ips]').map((idx, elem) => $(elem).val()).get()
        var deviceNAMES = $('input[name^=device_nicknames]').map((idx, elem) => $(elem).val()).get()

        for (var i = 0; i < deviceNAMES.length; i++) {
          if (deviceIPS[i].length > 0 && deviceNAMES[i].length > 0) {
            devices.push({ip: deviceIPS[i], nickname: deviceNAMES[i]})
          } else {
            setSaveButton("red", "white", __("Settings not saved!"))
            return resetSaveButton()
          }
        }
        Homey.set("devices", devices)
        console.log("Settings saved successfully.")
        setSaveButton("green", "white", __("Settings saved!"))
        resetSaveButton()
      }

      function resetSaveButton() {
        setTimeout(function() {
          setSaveButton("", "black", __("Save settings"))
        }, 3000)
      }

      function setSaveButton(backgroundColor, color, innerHtml) {
        var btnSave = document.getElementById("save")
        btnSave.style["background-color"] = backgroundColor
        btnSave.style["color"] = color
        btnSave.innerHTML = innerHtml
      }
    </script>
  </body>
</html>
